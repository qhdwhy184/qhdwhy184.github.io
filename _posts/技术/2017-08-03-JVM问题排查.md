---
layout: post
title: JVM问题排查
category: 技术
tags: JVM
keywords: JVM
description: 
---

### JVM问题排查
1. 线程数飙升，查看处于各状态下的线程数统计

``` 
grep "java.lang.Thread.State" /tmp/jvmdump | sort | uniq -c | sort -nr
``` 

2. CPU负载过高排查，抓取CPU使用率前五

```
#!/bin/bash
# @Function
# Find the High cpu consume thread of java, and print the stack of these threads.
#
# @Usage
#   $ ./show-busy-java-threads.sh
#
# @author Jerry Lee
redEcho()
{
    echo -e "\033[1;31m$@\033[0m"
}
uuid=`date +%s`_${RANDOM}_$$
ps -Leo pid,lwp,user,comm,pcpu --no-headers `jps -lvm| awk -F " " '{print $1}'`  |
sort -k5 -r -n | head -5 | while read threadLine ; do
        pid=`echo ${threadLine} | awk '{print $1}'`
        threadId=`echo ${threadLine} | awk '{print $2}'`
        threadId0x=`printf %x ${threadId}`
        user=`echo ${threadLine} | awk '{print $3}'`
        pcpu=`echo ${threadLine} | awk '{print $5}'`
        jstackFile=/tmp/${uuid}_${pid}
        [ ! -f "${jstackFile}" ] &&
        {
            jstack ${pid} > ${jstackFile} ||
            { redEcho "Fail to jstack java process ${pid}"; rm ${jstackFile} ; continue; }
        }
        redEcho "The stack of busy(${pcpu}%) thread(${threadId}/0x${threadId0x}) of java process(${pid}) of user(${user}):"
        sed "/nid=0x${threadId0x}/,/^$/p" -n ${jstackFile}
done
rm /tmp/${uuid}_*
```